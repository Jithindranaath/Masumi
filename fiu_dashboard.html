<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIU Platform - AI Financial Management</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8fafc; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; text-align: center; }
        .nav { display: flex; justify-content: center; gap: 20px; margin: 20px 0; }
        .nav-btn { background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; transition: all 0.3s; }
        .nav-btn:hover, .nav-btn.active { background: rgba(255,255,255,0.3); }
        .section { background: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .form-group { margin-bottom: 15px; }
        .label { display: block; margin-bottom: 5px; font-weight: 600; color: #374151; }
        .input, .select { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: border-color 0.3s; }
        .input:focus, .select:focus { outline: none; border-color: #667eea; }
        .btn { background: #667eea; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .btn:hover { background: #5a67d8; transform: translateY(-1px); }
        .btn-success { background: #10b981; }
        .btn-danger { background: #ef4444; }
        .btn-warning { background: #f59e0b; }
        .card { background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #667eea; }
        .balance-card { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; text-align: center; }
        .transaction-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #e5e7eb; }
        .transaction-item:last-child { border-bottom: none; }
        .amount-credit { color: #10b981; font-weight: bold; }
        .amount-debit { color: #ef4444; font-weight: bold; }
        .status-indicator { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .status-completed { background: #d1fae5; color: #065f46; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .alert-success { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .alert-error { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .loading { text-align: center; padding: 40px; }
        .spinner { border: 3px solid #f3f4f6; border-top: 3px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-value { font-size: 2em; font-weight: bold; color: #667eea; }
        .stat-label { color: #6b7280; margin-top: 5px; }
        .budget-report { background: #f9fafb; padding: 20px; border-radius: 8px; white-space: pre-wrap; font-family: 'Courier New', monospace; max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; }
        .validation-message { font-size: 12px; margin-top: 5px; }
        .validation-success { color: #10b981; }
        .validation-error { color: #ef4444; }
        .validation-warning { color: #f59e0b; }
        .bank-suggestion { background: #f0f9ff; border: 1px solid #0ea5e9; padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 14px; }
        .category-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px; }
        .category-btn { background: #f8fafc; border: 1px solid #e2e8f0; padding: 8px 12px; border-radius: 6px; cursor: pointer; text-align: center; transition: all 0.3s; }
        .category-btn:hover { background: #e2e8f0; }
        .category-btn.selected { background: #667eea; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¶ FIU Platform</h1>
            <p>AI-Powered Financial Information User Platform with Masumi Integration</p>
            <div class="nav">
                <button class="nav-btn active" onclick="showSection('dashboard')">Dashboard</button>
                <button class="nav-btn" onclick="showSection('accounts')">Accounts</button>
                <button class="nav-btn" onclick="showSection('transactions')">Transactions</button>
                <button class="nav-btn" onclick="showSection('transfer')">Transfer</button>
                <button class="nav-btn" onclick="showSection('budget')">AI Budget</button>
            </div>
        </div>

        <div id="alerts"></div>

        <!-- User Setup Section -->
        <div id="userSetup" class="section">
            <h2>üë§ User Registration</h2>
            <div class="form-grid">
                <div>
                    <div class="form-group">
                        <label class="label">Full Name:</label>
                        <input type="text" id="userName" class="input" placeholder="Enter your full name">
                    </div>
                    <div class="form-group">
                        <label class="label">Email:</label>
                        <input type="email" id="userEmail" class="input" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label class="label">Phone:</label>
                        <input type="tel" id="userPhone" class="input" placeholder="Enter your phone number">
                    </div>
                    <button class="btn" onclick="createUser()">Create Account</button>
                </div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="section hidden">
            <h2>üìä Financial Dashboard</h2>
            <div class="stats-grid">
                <div class="stat-card balance-card">
                    <div class="stat-value" id="totalBalance">Rs.0</div>
                    <div class="stat-label">Total Balance</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalAccounts">0</div>
                    <div class="stat-label">Bank Accounts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalTransactions">0</div>
                    <div class="stat-label">Transactions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="savingsRate">0%</div>
                    <div class="stat-label">Savings Rate</div>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="card">
                    <h3>üí∞ Quick Add Income</h3>
                    <div class="form-group">
                        <input type="number" id="quickIncomeAmount" class="input" placeholder="Amount">
                    </div>
                    <div class="form-group">
                        <input type="text" id="quickIncomeSource" class="input" placeholder="Income source">
                    </div>
                    <button class="btn btn-success" onclick="quickAddIncome()">Add Income</button>
                </div>
                
                <div class="card">
                    <h3>üí∏ Quick Add Expense</h3>
                    <div class="form-group">
                        <input type="number" id="quickExpenseAmount" class="input" placeholder="Amount">
                    </div>
                    <div class="form-group">
                        <select id="quickExpenseCategory" class="select">
                            <option value="Food">Food & Dining</option>
                            <option value="Transport">Transportation</option>
                            <option value="Shopping">Shopping</option>
                            <option value="Bills">Bills & Utilities</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Healthcare">Healthcare</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <button class="btn btn-danger" onclick="quickAddExpense()">Add Expense</button>
                </div>
            </div>
        </div>

        <!-- Accounts Section -->
        <div id="accounts" class="section hidden">
            <h2>üè¶ Bank Accounts</h2>
            <div class="form-grid">
                <div>
                    <h3>Add New Bank Account</h3>
                    <div class="form-group">
                        <label class="label">Account Number:</label>
                        <input type="text" id="accountNumber" class="input" placeholder="Enter account number">
                    </div>
                    <div class="form-group">
                        <label class="label">Bank Name:</label>
                        <input type="text" id="bankName" class="input" placeholder="Enter bank name">
                    </div>
                    <div class="form-group">
                        <label class="label">Account Type:</label>
                        <select id="accountType" class="select">
                            <option value="savings">Savings</option>
                            <option value="current">Current</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="label">IFSC Code:</label>
                        <input type="text" id="ifscCode" class="input" placeholder="Enter IFSC code" onblur="validateIFSC()">
                        <div id="ifscValidation" class="validation-message"></div>
                    </div>
                    <div class="form-group">
                        <label class="label">Account Holder Name:</label>
                        <input type="text" id="accountHolderName" class="input" placeholder="Enter account holder name">
                    </div>
                    <div class="form-group">
                        <label class="label">Initial Balance:</label>
                        <input type="number" id="initialBalance" class="input" placeholder="Enter initial balance">
                    </div>
                    <button class="btn" onclick="addBankAccount()">Add Account</button>
                </div>
                <div>
                    <h3>Your Accounts</h3>
                    <div id="accountsList"></div>
                    <div style="margin-top: 20px;">
                        <h4>Bank Account Sync</h4>
                        <p>Sync your account balance and transactions from your bank</p>
                        <button class="btn" onclick="syncAllAccounts()">Sync All Accounts</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transactions Section -->
        <div id="transactions" class="section hidden">
            <h2>üìã Transaction History</h2>
            <div class="form-grid">
                <div>
                    <h3>üí∞ Add Income</h3>
                    <div class="form-group">
                        <select id="incomeAccount" class="select">
                            <option value="">Select Account</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="number" id="incomeAmount" class="input" placeholder="Amount">
                    </div>
                    <div class="form-group">
                        <label class="label">Income Category:</label>
                        <div id="incomeCategoryGrid" class="category-grid"></div>
                        <input type="hidden" id="selectedIncomeCategory" value="salary">
                    </div>
                    <div class="form-group">
                        <label class="label">Source:</label>
                        <input type="text" id="incomeSource" class="input" placeholder="Income source (e.g., Company name)">
                    </div>
                    <div class="form-group">
                        <input type="text" id="incomeDescription" class="input" placeholder="Description (optional)">
                    </div>
                    <button class="btn btn-success" onclick="addIncome()">Add Income</button>
                </div>
                
                <div>
                    <h3>üí∏ Add Expense</h3>
                    <div class="form-group">
                        <select id="expenseAccount" class="select">
                            <option value="">Select Account</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="number" id="expenseAmount" class="input" placeholder="Amount">
                    </div>
                    <div class="form-group">
                        <label class="label">Category:</label>
                        <div id="expenseCategoryGrid" class="category-grid"></div>
                        <input type="hidden" id="selectedExpenseCategory" value="food">
                    </div>
                    <div class="form-group">
                        <label class="label">Merchant/Store (Optional):</label>
                        <input type="text" id="expenseMerchant" class="input" placeholder="Where did you spend?">
                    </div>
                    <div class="form-group">
                        <input type="text" id="expenseDescription" class="input" placeholder="Description (optional)">
                    </div>
                    <button class="btn btn-danger" onclick="addExpense()">Add Expense</button>
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <h3>Recent Transactions</h3>
                <div id="transactionsList"></div>
            </div>
        </div>

        <!-- Transfer Section -->
        <div id="transfer" class="section hidden">
            <h2>üí∏ Money Transfer</h2>
            <div class="form-grid">
                <div>
                    <h3>Transfer Money</h3>
                    <div class="form-group">
                        <label class="label">From Account:</label>
                        <select id="fromAccount" class="select">
                            <option value="">Select Account</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="label">To Account Number:</label>
                        <input type="text" id="toAccount" class="input" placeholder="Enter recipient account number">
                    </div>
                    <div class="form-group">
                        <label class="label">Amount:</label>
                        <input type="number" id="transferAmount" class="input" placeholder="Enter amount">
                    </div>
                    <div class="form-group">
                        <label class="label">Description:</label>
                        <input type="text" id="transferDescription" class="input" placeholder="Transfer description (optional)">
                    </div>
                    <button class="btn btn-warning" onclick="transferMoney()">Transfer Money</button>
                </div>
            </div>
        </div>

        <!-- Budget Section -->
        <div id="budget" class="section hidden">
            <h2>ü§ñ AI Budget Analysis</h2>
            <div class="form-grid">
                <div>
                    <h3>Generate AI Budget Report</h3>
                    <p>Our AI agent will analyze your income, expenses, and transaction patterns to provide personalized budget recommendations.</p>
                    <button class="btn" onclick="generateBudgetAnalysis()">üöÄ Analyze My Finances</button>
                </div>
            </div>
            
            <div id="budgetLoading" class="loading hidden">
                <div class="spinner"></div>
                <p>AI is analyzing your financial data...</p>
            </div>
            
            <div id="budgetResults" class="hidden">
                <h3>üìä Your AI Budget Report</h3>
                <div id="budgetReport" class="budget-report"></div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let userAccounts = [];

        // Navigation
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                if (section.id === sectionName) {
                    section.classList.remove('hidden');
                } else {
                    section.classList.add('hidden');
                }
            });
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (sectionName !== 'userSetup') {
                loadUserData();
            }
        }

        // Utility functions
        function showAlert(message, type = 'success') {
            const alertsDiv = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertsDiv.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' }
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            const response = await fetch(`/api${endpoint}`, options);
            return await response.json();
        }

        // User management
        async function createUser() {
            const name = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;
            const phone = document.getElementById('userPhone').value;
            
            if (!name || !email || !phone) {
                showAlert('Please fill all fields', 'error');
                return;
            }
            
            try {
                const result = await apiCall('/users/create', 'POST', { name, email, phone });
                if (result.success) {
                    currentUser = result.user_id;
                    localStorage.setItem('fiu_user_id', currentUser);
                    showAlert('Account created successfully!');
                    document.getElementById('userSetup').classList.add('hidden');
                    showSection('dashboard');
                } else {
                    showAlert(result.error || 'Failed to create account', 'error');
                }
            } catch (error) {
                showAlert('Error creating account', 'error');
            }
        }

        // Account management
        async function addBankAccount() {
            if (!currentUser) return;
            
            const accountNumber = document.getElementById('accountNumber').value;
            const bankName = document.getElementById('bankName').value;
            const accountType = document.getElementById('accountType').value;
            const ifscCode = document.getElementById('ifscCode').value;
            const accountHolderName = document.getElementById('accountHolderName').value;
            const initialBalance = parseFloat(document.getElementById('initialBalance').value) || 0;
            
            if (!accountNumber || !bankName || !ifscCode || !accountHolderName) {
                showAlert('Please fill all required fields', 'error');
                return;
            }
            
            try {
                const result = await apiCall('/accounts/add', 'POST', {
                    user_id: currentUser,
                    account_number: accountNumber,
                    bank_name: bankName,
                    account_type: accountType,
                    ifsc_code: ifscCode,
                    account_holder_name: accountHolderName,
                    initial_balance: initialBalance
                });
                
                if (result.success) {
                    showAlert('Bank account added successfully!');
                    document.getElementById('accountNumber').value = '';
                    document.getElementById('bankName').value = '';
                    document.getElementById('ifscCode').value = '';
                    document.getElementById('accountHolderName').value = '';
                    document.getElementById('initialBalance').value = '';
                    document.getElementById('ifscValidation').innerHTML = '';
                    loadUserAccounts();
                } else {
                    showAlert(result.error || 'Failed to add account', 'error');
                }
            } catch (error) {
                showAlert('Error adding account', 'error');
            }
        }

        async function loadUserAccounts() {
            if (!currentUser) return;
            
            try {
                const result = await apiCall(`/accounts/${currentUser}`);
                userAccounts = result.accounts || [];
                
                // Update accounts list
                const accountsList = document.getElementById('accountsList');
                accountsList.innerHTML = '';
                
                let totalBalance = 0;
                userAccounts.forEach(account => {
                    totalBalance += account.balance;
                    const accountDiv = document.createElement('div');
                    accountDiv.className = 'card';
                    accountDiv.innerHTML = `
                        <h4>${account.bank_name} ${account.is_primary ? '(Primary)' : ''}</h4>
                        <p>Account: ${account.account_number}</p>
                        <p>Type: ${account.account_type}</p>
                        <p>Balance: <strong>Rs.${account.balance.toLocaleString()}</strong></p>
                        <div style="margin-top: 10px;">
                            <button class="btn" style="font-size: 12px; padding: 6px 12px; margin-right: 5px;" onclick="syncAccount(${account.id})">Sync Account</button>
                            <button class="btn btn-success" style="font-size: 12px; padding: 6px 12px;" onclick="syncTransactions(${account.id})">Sync Transactions</button>
                        </div>
                    `;
                    accountsList.appendChild(accountDiv);
                });
                
                // Update dashboard stats
                document.getElementById('totalBalance').textContent = `Rs.${totalBalance.toLocaleString()}`;
                document.getElementById('totalAccounts').textContent = userAccounts.length;
                
                // Update account dropdowns
                updateAccountDropdowns();
                
            } catch (error) {
                console.error('Error loading accounts:', error);
            }
        }

        function updateAccountDropdowns() {
            const dropdowns = ['incomeAccount', 'expenseAccount', 'fromAccount'];
            dropdowns.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                dropdown.innerHTML = '<option value="">Select Account</option>';
                userAccounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.account_number;
                    option.textContent = `${account.bank_name} - ${account.account_number}`;
                    dropdown.appendChild(option);
                });
            });
        }

        // Transaction management
        async function addIncome() {
            if (!currentUser) return;
            
            const accountNumber = document.getElementById('incomeAccount').value;
            const amount = parseFloat(document.getElementById('incomeAmount').value);
            const category = document.getElementById('selectedIncomeCategory').value;
            const source = document.getElementById('incomeSource').value;
            const description = document.getElementById('incomeDescription').value;
            
            if (!accountNumber || !amount || !source) {
                showAlert('Please fill all required fields', 'error');
                return;
            }
            
            try {
                const result = await apiCall('/income/add', 'POST', {
                    user_id: currentUser,
                    account_number: accountNumber,
                    amount: amount,
                    source: source,
                    description: description,
                    category: category
                });
                
                if (result.success) {
                    showAlert('Income added successfully!');
                    document.getElementById('incomeAmount').value = '';
                    document.getElementById('incomeSource').value = '';
                    document.getElementById('incomeDescription').value = '';
                    loadUserAccounts();
                    loadTransactions();
                } else {
                    showAlert(result.error || 'Failed to add income', 'error');
                }
            } catch (error) {
                showAlert('Error adding income', 'error');
            }
        }

        async function addExpense() {
            if (!currentUser) return;
            
            const accountNumber = document.getElementById('expenseAccount').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const category = document.getElementById('selectedExpenseCategory').value;
            const merchant = document.getElementById('expenseMerchant').value;
            const description = document.getElementById('expenseDescription').value;
            
            if (!accountNumber || !amount || !category) {
                showAlert('Please fill all required fields', 'error');
                return;
            }
            
            try {
                const result = await apiCall('/expense/add', 'POST', {
                    user_id: currentUser,
                    account_number: accountNumber,
                    amount: amount,
                    category: category,
                    description: description,
                    merchant: merchant
                });
                
                if (result.success) {
                    showAlert('Expense added successfully!');
                    document.getElementById('expenseAmount').value = '';
                    document.getElementById('expenseMerchant').value = '';
                    document.getElementById('expenseDescription').value = '';
                    loadUserAccounts();
                    loadTransactions();
                } else {
                    showAlert(result.error || 'Failed to add expense', 'error');
                }
            } catch (error) {
                showAlert('Error adding expense', 'error');
            }
        }

        async function quickAddIncome() {
            if (!currentUser || userAccounts.length === 0) {
                showAlert('Please add a bank account first', 'error');
                return;
            }
            
            const amount = parseFloat(document.getElementById('quickIncomeAmount').value);
            const source = document.getElementById('quickIncomeSource').value;
            
            if (!amount || !source) {
                showAlert('Please fill all fields', 'error');
                return;
            }
            
            const primaryAccount = userAccounts.find(acc => acc.is_primary) || userAccounts[0];
            
            try {
                const result = await apiCall('/income/add', 'POST', {
                    user_id: currentUser,
                    account_number: primaryAccount.account_number,
                    amount: amount,
                    source: source,
                    description: 'Quick add income'
                });
                
                if (result.success) {
                    showAlert('Income added successfully!');
                    document.getElementById('quickIncomeAmount').value = '';
                    document.getElementById('quickIncomeSource').value = '';
                    loadUserAccounts();
                } else {
                    showAlert(result.error || 'Failed to add income', 'error');
                }
            } catch (error) {
                showAlert('Error adding income', 'error');
            }
        }

        async function quickAddExpense() {
            if (!currentUser || userAccounts.length === 0) {
                showAlert('Please add a bank account first', 'error');
                return;
            }
            
            const amount = parseFloat(document.getElementById('quickExpenseAmount').value);
            const category = document.getElementById('quickExpenseCategory').value;
            
            if (!amount || !category) {
                showAlert('Please fill all fields', 'error');
                return;
            }
            
            const primaryAccount = userAccounts.find(acc => acc.is_primary) || userAccounts[0];
            
            try {
                const result = await apiCall('/expense/add', 'POST', {
                    user_id: currentUser,
                    account_number: primaryAccount.account_number,
                    amount: amount,
                    category: category,
                    description: 'Quick add expense'
                });
                
                if (result.success) {
                    showAlert('Expense added successfully!');
                    document.getElementById('quickExpenseAmount').value = '';
                    loadUserAccounts();
                } else {
                    showAlert(result.error || 'Failed to add expense', 'error');
                }
            } catch (error) {
                showAlert('Error adding expense', 'error');
            }
        }

        async function transferMoney() {
            if (!currentUser) return;
            
            const fromAccount = document.getElementById('fromAccount').value;
            const toAccount = document.getElementById('toAccount').value;
            const amount = parseFloat(document.getElementById('transferAmount').value);
            const description = document.getElementById('transferDescription').value;
            
            if (!fromAccount || !toAccount || !amount) {
                showAlert('Please fill all required fields', 'error');
                return;
            }
            
            try {
                const result = await apiCall('/transfer', 'POST', {
                    user_id: currentUser,
                    from_account: fromAccount,
                    to_account: toAccount,
                    amount: amount,
                    description: description
                });
                
                if (result.success) {
                    showAlert(`Transfer completed! Masumi TX: ${result.masumi_tx_hash}`);
                    document.getElementById('toAccount').value = '';
                    document.getElementById('transferAmount').value = '';
                    document.getElementById('transferDescription').value = '';
                    loadUserAccounts();
                    loadTransactions();
                } else {
                    showAlert(result.error || 'Transfer failed', 'error');
                }
            } catch (error) {
                showAlert('Error processing transfer', 'error');
            }
        }

        async function loadTransactions() {
            if (!currentUser) return;
            
            try {
                const result = await apiCall(`/transactions/${currentUser}`);
                const transactions = result.transactions || [];
                
                document.getElementById('totalTransactions').textContent = transactions.length;
                
                const transactionsList = document.getElementById('transactionsList');
                transactionsList.innerHTML = '';
                
                transactions.slice(0, 10).forEach(tx => {
                    const txDiv = document.createElement('div');
                    txDiv.className = 'transaction-item';
                    
                    const amountClass = tx.type === 'credit' ? 'amount-credit' : 'amount-debit';
                    const amountSign = tx.type === 'credit' ? '+' : '-';
                    
                    txDiv.innerHTML = `
                        <div>
                            <strong>${tx.description}</strong>
                            <br>
                            <small>${new Date(tx.date).toLocaleDateString()} ‚Ä¢ ${tx.masumi_tx_hash?.substring(0, 8)}...</small>
                        </div>
                        <div>
                            <span class="${amountClass}">${amountSign}Rs.${tx.amount.toLocaleString()}</span>
                            <br>
                            <span class="status-indicator status-${tx.status}">${tx.status}</span>
                        </div>
                    `;
                    transactionsList.appendChild(txDiv);
                });
                
            } catch (error) {
                console.error('Error loading transactions:', error);
            }
        }

        async function generateBudgetAnalysis() {
            if (!currentUser) return;
            
            document.getElementById('budgetLoading').classList.remove('hidden');
            document.getElementById('budgetResults').classList.add('hidden');
            
            try {
                const result = await apiCall('/budget/analyze', 'POST', { user_id: currentUser });
                
                if (result.success) {
                    document.getElementById('budgetReport').textContent = result.budget_report;
                    document.getElementById('savingsRate').textContent = `${result.savings_rate.toFixed(1)}%`;
                    document.getElementById('budgetResults').classList.remove('hidden');
                    showAlert('Budget analysis completed!');
                } else {
                    showAlert(result.error || 'Failed to generate budget analysis', 'error');
                }
            } catch (error) {
                showAlert('Error generating budget analysis', 'error');
            } finally {
                document.getElementById('budgetLoading').classList.add('hidden');
            }
        }

        async function loadUserData() {
            if (currentUser) {
                await loadUserAccounts();
                await loadTransactions();
            }
        }

        // Bank validation functions
        async function validateIFSC() {
            const ifscCode = document.getElementById('ifscCode').value;
            const validationDiv = document.getElementById('ifscValidation');
            
            if (!ifscCode) {
                validationDiv.innerHTML = '';
                return;
            }
            
            try {
                const result = await apiCall('/banks/validate', 'POST', {
                    ifsc_code: ifscCode,
                    account_number: '123456789012',
                    account_holder_name: 'Test',
                    account_type: 'savings'
                });
                
                if (result.valid) {
                    validationDiv.innerHTML = `<span class="validation-success">‚úì Valid IFSC - ${result.bank_info.bank_name}</span>`;
                    document.getElementById('bankName').value = result.bank_info.bank_name;
                } else {
                    validationDiv.innerHTML = `<span class="validation-error">‚úó ${result.errors.join(', ')}</span>`;
                }
            } catch (error) {
                validationDiv.innerHTML = `<span class="validation-error">‚úó Unable to validate IFSC</span>`;
            }
        }
        
        async function loadCategories() {
            try {
                // Load expense categories
                const expenseResult = await apiCall('/categories/expense');
                const expenseGrid = document.getElementById('expenseCategoryGrid');
                expenseGrid.innerHTML = '';
                
                expenseResult.categories.forEach(category => {
                    const btn = document.createElement('div');
                    btn.className = 'category-btn';
                    btn.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                    btn.onclick = () => selectExpenseCategory(category, btn);
                    if (category === 'food') btn.classList.add('selected');
                    expenseGrid.appendChild(btn);
                });
                
                // Load income categories
                const incomeResult = await apiCall('/categories/income');
                const incomeGrid = document.getElementById('incomeCategoryGrid');
                incomeGrid.innerHTML = '';
                
                incomeResult.categories.forEach(category => {
                    const btn = document.createElement('div');
                    btn.className = 'category-btn';
                    btn.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                    btn.onclick = () => selectIncomeCategory(category, btn);
                    if (category === 'salary') btn.classList.add('selected');
                    incomeGrid.appendChild(btn);
                });
                
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }
        
        function selectExpenseCategory(category, btn) {
            document.querySelectorAll('#expenseCategoryGrid .category-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            document.getElementById('selectedExpenseCategory').value = category;
        }
        
        function selectIncomeCategory(category, btn) {
            document.querySelectorAll('#incomeCategoryGrid .category-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            document.getElementById('selectedIncomeCategory').value = category;
        }

        // Bank sync functions
        async function syncAccount(accountId) {
            try {
                showAlert('Syncing account balance...', 'info');
                const result = await apiCall(`/accounts/${accountId}/sync/full`, 'POST');
                
                if (result.success) {
                    showAlert(`Account synced successfully! Found ${result.transactions_sync.synced_count} new transactions`);
                    loadUserAccounts();
                    loadTransactions();
                } else {
                    showAlert('Failed to sync account', 'error');
                }
            } catch (error) {
                showAlert('Error syncing account', 'error');
            }
        }
        
        async function syncTransactions(accountId) {
            try {
                showAlert('Syncing transactions...', 'info');
                const result = await apiCall(`/accounts/${accountId}/sync/transactions`, 'POST');
                
                if (result.success) {
                    showAlert(`Synced ${result.synced_count} transactions successfully!`);
                    loadTransactions();
                } else {
                    showAlert('Failed to sync transactions', 'error');
                }
            } catch (error) {
                showAlert('Error syncing transactions', 'error');
            }
        }
        
        async function syncAllAccounts() {
            if (!currentUser || userAccounts.length === 0) {
                showAlert('No accounts to sync', 'error');
                return;
            }
            
            showAlert('Syncing all accounts...', 'info');
            
            for (const account of userAccounts) {
                try {
                    await apiCall(`/accounts/${account.id}/sync/full`, 'POST');
                } catch (error) {
                    console.error(`Failed to sync account ${account.id}:`, error);
                }
            }
            
            showAlert('All accounts synced successfully!');
            loadUserAccounts();
            loadTransactions();
        }

        // Initialize app
        window.addEventListener('load', function() {
            currentUser = localStorage.getItem('fiu_user_id');
            if (currentUser) {
                document.getElementById('userSetup').classList.add('hidden');
                showSection('dashboard');
            } else {
                document.getElementById('userSetup').classList.remove('hidden');
            }
            loadCategories();
        });
    </script>
</body>
</html>